#' @title Function \code{write_makefile}
#' @description Takes a collection of \code{remake} YAML files (github.com/richfitz/remake)
#' and creates an overarching Makefile to run them all in parallelizable stages 
#' (with \code{make -j} on the command line).
#' @export
#' @param stages List of character vectors. Organizes the steps of a 
#' workflow into parallelizable stages. Each character string is a 
#' path to a \code{remake}/YAML file encoding a step in the workflow.
#' The ".yml" file extension is optional.
#' @param begin Character vector of lines to prepend to the Makefile.
#' @param clean Character vector of commands to add to the \code{clean} rule.
#' @param file Name of Makefile. This can also be a file path, but make sure that 
#' the Makefile ends up in a place where it can call the \code{YAML} files in 
#' \code{stages}
write_makefile = function(stages, begin = NULL, clean = NULL, file = "Makefile"){
  if(!length(stages)) stop("no workflow stages. Nothing to do.")
  stages = lapply(stages, gsub, pattern = ".yml$", replacement = "")
  check_stages(stages)
  sink(file)
  cat("# Generated by parallelRemake::write_makefile() on", as.character(Sys.time()), "\n\n")
  if(!is.null(begin)){
    cat(begin, sep = "\n")
    cat("\n")
  }
  cat(".PHONY: all clean_cache clean reset", 
    names(stages), unlist(stages), "\n\n")
  cat("all:", stages[[length(stages)]], "\n\n")

  for(i in length(stages):1){
    cat(names(stages)[i], ": ", sep = "")
    cat(stages[[i]], "\n\n")
  }

  for(i in length(stages):1)
    for(j in 1:length(stages[[i]])){
      yaml = stages[[i]][j]
      cat(yaml, ": ", sep = "")
      if(i > 1) cat(stages[[i - 1]])
      cat("\n\tRscript -e \'remake::make(remake_file = \"", 
        yaml, ".yml\")\'\n\n", sep = "")
    }

  cat("reset: clean\n\trm -f", file, "\n")
    for(y in unlist(stages)) cat("\trm -f ", y, ".yml\n", sep = "")
  cat("\n")

  cat("clean: clean_cache\n")
  for(rule in clean) cat("\t", str_trim(rule), "\n", sep = "")
  cat("\n")

  cat("clean_cache:", paste0("clean_", stages[[1]]), "\n")
  cat("\trm -rf .remake\n\n")

  for(i in 1:length(stages))
    for(j in 1:length(stages[[i]])){
      yaml = paste0(stages[[i]][j])
      cat("clean_", yaml, ": ", sep = "")
      if(i < length(stages))
        cat(paste0("clean_", stages[[i + 1]], sep = ""))
      cat("\n\tRscript -e \'remake::make(\"clean\", remake_file = \"", 
        yaml, ".yml\")\'\n\n", sep = "")
    }

  sink()
}
