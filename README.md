This R package helps to manage large R workflows. It uses GNU make to manage parallel instances of [`remake`](https://github.com/richfitz/remake)

# Installation

Open an R session and run 

```
library(devtools)
install_github("wlandau/workflowHelper")
```

Alternatively, you can build the package from the source and install it by hand.

Open a command line program such as Terminal in Mac/Linux and enter the following commands.

```
git clone git@github.com:wlandau/workflowHelper.git
R CMD build workflowHelper
R CMD INSTALL ...
```

where `...` is replaced by the name of the tarball produced by `R CMD build`. 

# Running remake in parallel

Suppose I have some R code in `code.R`.

```
wrapper_function = function(file){
  generate_data(file)
}

generate_data = function(file){
  data(mtcars)
  n = dim(mtcars)[1]
  mtcars$cyl = rpois(n, 5) # COMMENT/UNCOMMENT THIS LINE TO SEE HOW remake::make() RESPONDS
  write.csv(mtcars, file = file)
}

process_data = function(filename){
  d = read.csv(filename)
  data.frame(x = d$mpg, y = d$cyl)
}

myplot = function(data){
  plot(y~x, data = data)
}

```

I have a workflow defined in `remake1.yml`

```
sources:
  - code.R

targets:
  all:
    depends: plot1.pdf

  data1.csv:
    command: wrapper_function("data1.csv")

  processed1:
    command: process_data("data1.csv")

  plot1.pdf:
    command: myplot(processed1)
    plot: true
```

I also have remake files `remake<i>.yml`, where `i` = 2, .., 6 (where data1.csv is `data<i>.csv`, etc.). I want to run `remake1.yml`, `remake2.yml`, and `remake3.yml` in parallel and then run `remake4.yml`, `remake5.yml`, and `remake6.yml` in parallel. First, I group the remake files into 2 parallel stages.

```
stages = list(
  paste0("remake", 1:3),
  paste0("remake", 4:6)
)
```

Then, I create a Makefile to run them in parallel.

```
remake2make(stages)
```

This produces the following `Makefile`.

```
# Generated by remake2make() on 2016-05-19 12:21:36 

.PHONY: all clean stage1 stage2 remake1 remake2 remake3 remake4 remake5 remake6 

all:  stage2 

stage2 : stage1 remake4 remake5 remake6 

stage1 :  remake1 remake2 remake3 

clean:
	Rscript -e 'remake::make("clean", remake_file = "remake1.yml")'
	Rscript -e 'remake::make("clean", remake_file = "remake2.yml")'
	Rscript -e 'remake::make("clean", remake_file = "remake3.yml")'
	Rscript -e 'remake::make("clean", remake_file = "remake4.yml")'
	Rscript -e 'remake::make("clean", remake_file = "remake5.yml")'
	Rscript -e 'remake::make("clean", remake_file = "remake6.yml")'

remake1:
	Rscript -e 'remake::make(remake_file = "remake1.yml")'

remake2:
	Rscript -e 'remake::make(remake_file = "remake2.yml")'

remake3:
	Rscript -e 'remake::make(remake_file = "remake3.yml")'

remake4:
	Rscript -e 'remake::make(remake_file = "remake4.yml")'

remake5:
	Rscript -e 'remake::make(remake_file = "remake5.yml")'

remake6:
	Rscript -e 'remake::make(remake_file = "remake6.yml")'

```

Now, using a shell program like BASH, I can run the whole workflow over 3 parallel processes with

```
make -j 3
```

and clean up with

```
make clean
```




